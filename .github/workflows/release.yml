name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to build (e.g., v1.6.1)"
        required: true
        default: ""

permissions:
  contents: write
  packages: write

env:
  TAG_NAME: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.ensure-release.outputs.upload_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gh CLI (if missing)
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y gh
          fi

      - name: Ensure draft release exists
        id: ensure-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          # Check for an existing draft release for this tag
          RELEASE_JSON=$(gh release view "$TAG_NAME" --json isDraft,uploadUrl 2>/dev/null || true)

          if echo "$RELEASE_JSON" | grep -q '"isDraft": true'; then
            echo "Using existing draft release"
            UPLOAD_URL=$(echo "$RELEASE_JSON" | jq -r '.uploadUrl')
          else
            echo "Creating new draft release"
            gh release create "$TAG_NAME" \
              --draft \
              --title "$TAG_NAME" \
              --notes ""
            UPLOAD_URL=$(gh release view "$TAG_NAME" --json uploadUrl | jq -r '.uploadUrl')
          fi

          echo "upload_url=$UPLOAD_URL" >> "$GITHUB_OUTPUT"

  release-mac:
    needs: prepare-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci
      - run: npm run build

      - name: Build (Mac)
        run: |
          npx electron-builder --mac --x64 --arm64 --publish never -c.mac.identity=null

      - name: List build output for debugging
        run: |
          echo "Current directory:"
          pwd
          echo "Listing files in dist folder:"
          find dist -type f 2>/dev/null || echo "No dist folder"
          echo "Listing all files recursively:"
          find . -type f -name "*.dmg" -o -name "*.AppImage" -o -name "*.exe" -o -name "*.deb" 2>/dev/null | head -20

      - name: Upload artifacts (Mac)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Look for .dmg files in common locations
          find . -name "*.dmg" -type f | while read file; do
            echo "Found file: $file"
            gh release upload "$TAG_NAME" "$file" --clobber
          done

  release-win:
    needs: prepare-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci
      - run: npm run build

      - name: Build (Windows)
        run: |
          npx electron-builder --win --x64 --publish never

      - name: List build output for debugging
        shell: bash
        run: |
          echo "Current directory:"
          pwd
          echo "Listing files in dist folder:"
          find dist -type f 2>/dev/null || echo "No dist folder"
          echo "Looking for .exe files:"
          find . -name "*.exe" -type f 2>/dev/null

      - name: Upload artifacts (Windows)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          # Upload .exe files matching the pattern
          find . -name "Pedro-Pathing-Visualizer-Setup-*.exe" -type f | while read file; do
            echo "Uploading: $file"
            gh release upload "$TAG_NAME" "$file" --clobber
          done

  release-linux:
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev

      - run: npm ci
      - run: npm run build

      - name: Build (Linux)
        run: |
          npx electron-builder --linux --x64 --arm64 --publish never

      - name: List build output for debugging
        run: |
          echo "Current directory:"
          pwd
          echo "Listing all files in current directory recursively:"
          find . -type f \( -name "*.AppImage" -o -name "*.deb" \) 2>/dev/null

      - name: Upload artifacts (Linux)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Upload .AppImage and .deb files
          find . -type f \( -name "*.AppImage" -o -name "*.deb" \) | while read file; do
            echo "Uploading: $file"
            gh release upload "$TAG_NAME" "$file" --clobber
          done
