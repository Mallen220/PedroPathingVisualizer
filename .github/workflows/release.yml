name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to build (e.g., v1.6.1)'
        required: true
        default: ''

permissions:
  contents: write
  packages: write

env:
  TAG_NAME: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.ensure-release.outputs.upload_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gh CLI (if missing)
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y gh
          fi

      - name: Generate Release Notes
        id: generate-notes
        run: |
          # 1. Create the static portion of the notes using a Heredoc
          # This avoids the need to escape backticks or quotes
          cat > base_notes.md << 'EOF'
          ## ðŸš€ Quick Update

          Refer to the README installation section for instructions on installing or updating Pedro Pathing Visualizer. Below is a condensed version of the instructions for quick reference.

          This repo is regularly updated with new features and bug fixes but tested primarily on macOS. Should an issue arise, please report it via the GitHub Issues page and revert to the previous stable version if needed.

          #### **macOS**
          Run the following command in terminal and provide your password when prompted:
          ```bash
          curl -fsSL [https://raw.githubusercontent.com/Mallen220/PedroPathingVisualizer/main/install.sh](https://raw.githubusercontent.com/Mallen220/PedroPathingVisualizer/main/install.sh) | bash
          ```

          #### **Windows**
          Download and install via the `.exe` installer below.

          #### **Linux**
          Download the `.deb`, `.tar.gz`, or `.AppImage` file. Run in terminal with executable permissions.

          ## ðŸ“ Release Notes
          EOF

          # 2. Extract version number (remove 'v' prefix)
          VERSION="${TAG_NAME#v}"
          
          # 3. Append Changelog logic
          if [ -f "CHANGELOG.md" ]; then
            # Extract section: matches "## X.Y.Z" and stops at the next "## "
            CHANGELOG_SECTION=$(awk -v version="$VERSION" '
              /^## / && p && $2 != version {exit}
              /^## / && $2 == version {p=1; next}
              p {print}
            ' CHANGELOG.md)
            
            if [ -n "$CHANGELOG_SECTION" ]; then
              echo "" >> base_notes.md
              echo "$CHANGELOG_SECTION" >> base_notes.md
            else
              echo "" >> base_notes.md
              echo "- Bug fixes and improvements" >> base_notes.md
            fi
          else
            echo "" >> base_notes.md
            echo "- Bug fixes and improvements" >> base_notes.md
          fi
          
          # 4. Finalize
          mv base_notes.md release-notes.md
          echo "Release notes generated."

      - name: Ensure draft release exists
        id: ensure-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          VERSION="${TAG_NAME#v}"
          TITLE="Pedro Pathing Visualizer ${VERSION}"

          # Check for existing release
          RELEASE_JSON=$(gh release view "$TAG_NAME" --json isDraft,uploadUrl 2>/dev/null || true)

          if echo "$RELEASE_JSON" | grep -q '"isDraft": true'; then
            echo "Using existing draft release"
            UPLOAD_URL=$(echo "$RELEASE_JSON" | jq -r '.uploadUrl')
          else
            echo "Creating new draft release"
            # If triggered by tag, we don't strictly need --target, 
            # but if dispatch, use the current ref.
            gh release create "$TAG_NAME" \
              --draft \
              --title "$TITLE" \
              --notes-file release-notes.md \
              --target "${{ github.sha }}"
            
            UPLOAD_URL=$(gh release view "$TAG_NAME" --json uploadUrl | jq -r '.uploadUrl')
          fi

          echo "upload_url=$UPLOAD_URL" >> "$GITHUB_OUTPUT"

      - name: Upload source code zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${TAG_NAME#v}"
          SOURCE_ZIP="Pedro-Pathing-Visualizer-${VERSION}-source.zip"
          
          # Create zip of the repository (excluding node_modules, dist, build artifacts)
          zip -r "$SOURCE_ZIP" . \
            -x "node_modules/*" \
            "dist/*" \
            ".git/*" \
            ".next/*" \
            "release/*" \
            ".github/*" \
            "*.blockmap" \
            ".DS_Store" \
            ".gitignore"
          
          echo "Uploading source code: $SOURCE_ZIP"
          gh release upload "$TAG_NAME" "$SOURCE_ZIP" --clobber

  release-mac:
    needs: prepare-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci
      - run: npm run build

      - name: Build (Mac)
        run: |
          npx electron-builder --mac --x64 --arm64 --publish never -c.mac.identity=null

      - name: Upload artifacts (Mac)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          find dist -name "*.dmg" -type f | while read file; do
            echo "Uploading: $file"
            gh release upload "$TAG_NAME" "$file" --clobber
          done

  release-win:
    needs: prepare-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci
      - run: npm run build

      - name: Build (Windows)
        run: |
          npx electron-builder --win --x64 --publish never

      - name: Upload artifacts (Windows)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          find dist -name "*.exe" -type f | while read file; do
            echo "Uploading: $file"
            gh release upload "$TAG_NAME" "$file" --clobber
          done

  release-linux:
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev

      - run: npm ci
      - run: npm run build

      - name: Build (Linux)
        run: |
          npx electron-builder --linux --x64 --arm64 --publish never

      - name: Upload artifacts (Linux)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          find dist -type f \( -name "*.AppImage" -o -name "*.deb" \) | while read file; do
            echo "Uploading: $file"
            gh release upload "$TAG_NAME" "$file" --clobber
          done