name: Boot Test

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  test-boot:
    name: Test Boot on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest, macos-14]
        # ubuntu-latest is x64
        # macos-latest is x64 (until GH changes default) or M1?
        # Currently macos-latest is macos-14 (Arm64) in some contexts but let's be explicit.
        # Actually macos-latest is now macos-14 (Arm64) as of recent updates, but macos-13 is Intel.
        # To be safe and explicit:
        # macos-13 is Intel.
        # macos-14 is Apple Silicon.
        # We want to test both if possible.
        include:
          - os: macos-13
            arch: x64
          - os: macos-14
            arch: arm64
          - os: ubuntu-latest
            arch: x64
          - os: windows-latest
            arch: x64
          # For ARM Ubuntu, there are no standard hosted runners yet.
          # If you have a self-hosted runner, you can uncomment this:
          # - os: ubuntu-arm64
          #   arch: arm64
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Application (Linux)
        if: runner.os == 'Linux'
        # We use --dir to get the unpacked executable for easier testing
        run: npx electron-builder --linux --x64 --dir

      - name: Build Application (Windows)
        if: runner.os == 'Windows'
        # We use --dir to get the unpacked executable
        run: npx electron-builder --win --x64 --dir

      - name: Build Application (macOS Intel)
        if: matrix.os == 'macos-13'
        # We build for x64.
        # Note: --mac implies default target (dmg + zip + mas potentially), but we just need the .app
        # electron-builder defaults to universal or current arch?
        # We specify --x64 explicitly.
        run: npx electron-builder --mac --x64 --dir --publish=never

      - name: Build Application (macOS Apple Silicon)
        if: matrix.os == 'macos-14'
        # We build for arm64.
        run: npx electron-builder --mac --arm64 --dir --publish=never

      - name: Run Playwright Tests
        shell: bash
        env:
          # On Linux, we need xvfb for Electron to run
          # Using xvfb-run to wrap the test command
          # On others, run directly
          # We need to determine if we should use xvfb-run
          USE_XVFB: ${{ runner.os == 'Linux' }}
        run: |
          npx playwright install-deps
          if [ "$USE_XVFB" = "true" ]; then
            xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" npx playwright test
          else
            npx playwright test
          fi

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: test-results/
